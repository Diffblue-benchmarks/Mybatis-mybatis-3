


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: XMLConfigBuilder</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">org.apache.ibatis.builder.xml</a> ]
</div>

<h1>Coverage Summary for Class: XMLConfigBuilder (org.apache.ibatis.builder.xml)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">XMLConfigBuilder</td>
<td class="coverageStat">
  <span class="percent">
    92.3%
  </span>
  <span class="absValue">
    (24/ 26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95.5%
  </span>
  <span class="absValue">
    (231/ 242)
  </span>
</td>
</tr>
  <tr>
    <td class="name">XMLConfigBuilder$$EnhancerByMockitoWithCGLIB$$3110f9ec</td>
  </tr>
<tr>
  <td class="name"><strong>total</strong></td>
<td class="coverageStat">
  <span class="percent">
    92.3%
  </span>
  <span class="absValue">
    (24/ 26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95.5%
  </span>
  <span class="absValue">
    (231/ 242)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<div class="sourceCode"><i>1</i>&nbsp;/**
<i>2</i>&nbsp; *    Copyright 2009-2019 the original author or authors.
<i>3</i>&nbsp; *
<i>4</i>&nbsp; *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
<i>5</i>&nbsp; *    you may not use this file except in compliance with the License.
<i>6</i>&nbsp; *    You may obtain a copy of the License at
<i>7</i>&nbsp; *
<i>8</i>&nbsp; *       http://www.apache.org/licenses/LICENSE-2.0
<i>9</i>&nbsp; *
<i>10</i>&nbsp; *    Unless required by applicable law or agreed to in writing, software
<i>11</i>&nbsp; *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
<i>12</i>&nbsp; *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
<i>13</i>&nbsp; *    See the License for the specific language governing permissions and
<i>14</i>&nbsp; *    limitations under the License.
<i>15</i>&nbsp; */
<i>16</i>&nbsp;package org.apache.ibatis.builder.xml;
<i>17</i>&nbsp;
<i>18</i>&nbsp;import java.io.InputStream;
<i>19</i>&nbsp;import java.io.Reader;
<i>20</i>&nbsp;import java.util.Properties;
<i>21</i>&nbsp;import javax.sql.DataSource;
<i>22</i>&nbsp;
<i>23</i>&nbsp;import org.apache.ibatis.builder.BaseBuilder;
<i>24</i>&nbsp;import org.apache.ibatis.builder.BuilderException;
<i>25</i>&nbsp;import org.apache.ibatis.datasource.DataSourceFactory;
<i>26</i>&nbsp;import org.apache.ibatis.executor.ErrorContext;
<i>27</i>&nbsp;import org.apache.ibatis.executor.loader.ProxyFactory;
<i>28</i>&nbsp;import org.apache.ibatis.io.Resources;
<i>29</i>&nbsp;import org.apache.ibatis.io.VFS;
<i>30</i>&nbsp;import org.apache.ibatis.logging.Log;
<i>31</i>&nbsp;import org.apache.ibatis.mapping.DatabaseIdProvider;
<i>32</i>&nbsp;import org.apache.ibatis.mapping.Environment;
<i>33</i>&nbsp;import org.apache.ibatis.parsing.XNode;
<i>34</i>&nbsp;import org.apache.ibatis.parsing.XPathParser;
<i>35</i>&nbsp;import org.apache.ibatis.plugin.Interceptor;
<i>36</i>&nbsp;import org.apache.ibatis.reflection.DefaultReflectorFactory;
<i>37</i>&nbsp;import org.apache.ibatis.reflection.MetaClass;
<i>38</i>&nbsp;import org.apache.ibatis.reflection.ReflectorFactory;
<i>39</i>&nbsp;import org.apache.ibatis.reflection.factory.ObjectFactory;
<i>40</i>&nbsp;import org.apache.ibatis.reflection.wrapper.ObjectWrapperFactory;
<i>41</i>&nbsp;import org.apache.ibatis.session.AutoMappingBehavior;
<i>42</i>&nbsp;import org.apache.ibatis.session.AutoMappingUnknownColumnBehavior;
<i>43</i>&nbsp;import org.apache.ibatis.session.Configuration;
<i>44</i>&nbsp;import org.apache.ibatis.session.ExecutorType;
<i>45</i>&nbsp;import org.apache.ibatis.session.LocalCacheScope;
<i>46</i>&nbsp;import org.apache.ibatis.transaction.TransactionFactory;
<i>47</i>&nbsp;import org.apache.ibatis.type.JdbcType;
<i>48</i>&nbsp;
<i>49</i>&nbsp;/**
<i>50</i>&nbsp; * @author Clinton Begin
<i>51</i>&nbsp; * @author Kazuki Shimizu
<i>52</i>&nbsp; */
<i>53</i>&nbsp;public class XMLConfigBuilder extends BaseBuilder {
<i>54</i>&nbsp;
<i>55</i>&nbsp;  private boolean parsed;
<i>56</i>&nbsp;  private final XPathParser parser;
<i>57</i>&nbsp;  private String environment;
<b class="fc"><i>58</i>&nbsp;  private final ReflectorFactory localReflectorFactory = new DefaultReflectorFactory();</b>
<i>59</i>&nbsp;
<i>60</i>&nbsp;  public XMLConfigBuilder(Reader reader) {
<b class="fc"><i>61</i>&nbsp;    this(reader, null, null);</b>
<b class="fc"><i>62</i>&nbsp;  }</b>
<i>63</i>&nbsp;
<i>64</i>&nbsp;  public XMLConfigBuilder(Reader reader, String environment) {
<b class="nc"><i>65</i>&nbsp;    this(reader, environment, null);</b>
<b class="nc"><i>66</i>&nbsp;  }</b>
<i>67</i>&nbsp;
<i>68</i>&nbsp;  public XMLConfigBuilder(Reader reader, String environment, Properties props) {
<b class="fc"><i>69</i>&nbsp;    this(new XPathParser(reader, true, props, new XMLMapperEntityResolver()), environment, props);</b>
<b class="fc"><i>70</i>&nbsp;  }</b>
<i>71</i>&nbsp;
<i>72</i>&nbsp;  public XMLConfigBuilder(InputStream inputStream) {
<b class="fc"><i>73</i>&nbsp;    this(inputStream, null, null);</b>
<b class="fc"><i>74</i>&nbsp;  }</b>
<i>75</i>&nbsp;
<i>76</i>&nbsp;  public XMLConfigBuilder(InputStream inputStream, String environment) {
<b class="nc"><i>77</i>&nbsp;    this(inputStream, environment, null);</b>
<b class="nc"><i>78</i>&nbsp;  }</b>
<i>79</i>&nbsp;
<i>80</i>&nbsp;  public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) {
<b class="fc"><i>81</i>&nbsp;    this(new XPathParser(inputStream, true, props, new XMLMapperEntityResolver()), environment, props);</b>
<b class="fc"><i>82</i>&nbsp;  }</b>
<i>83</i>&nbsp;
<i>84</i>&nbsp;  private XMLConfigBuilder(XPathParser parser, String environment, Properties props) {
<b class="fc"><i>85</i>&nbsp;    super(new Configuration());</b>
<b class="fc"><i>86</i>&nbsp;    ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</b>
<b class="fc"><i>87</i>&nbsp;    this.configuration.setVariables(props);</b>
<b class="fc"><i>88</i>&nbsp;    this.parsed = false;</b>
<b class="fc"><i>89</i>&nbsp;    this.environment = environment;</b>
<b class="fc"><i>90</i>&nbsp;    this.parser = parser;</b>
<b class="fc"><i>91</i>&nbsp;  }</b>
<i>92</i>&nbsp;
<i>93</i>&nbsp;  public Configuration parse() {
<b class="fc"><i>94</i>&nbsp;    if (parsed) {</b>
<b class="fc"><i>95</i>&nbsp;      throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</b>
<i>96</i>&nbsp;    }
<b class="fc"><i>97</i>&nbsp;    parsed = true;</b>
<b class="fc"><i>98</i>&nbsp;    parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</b>
<b class="fc"><i>99</i>&nbsp;    return configuration;</b>
<i>100</i>&nbsp;  }
<i>101</i>&nbsp;
<i>102</i>&nbsp;  private void parseConfiguration(XNode root) {
<i>103</i>&nbsp;    try {
<i>104</i>&nbsp;      //issue #117 read properties first
<b class="fc"><i>105</i>&nbsp;      propertiesElement(root.evalNode(&quot;properties&quot;));</b>
<b class="fc"><i>106</i>&nbsp;      Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</b>
<b class="fc"><i>107</i>&nbsp;      loadCustomVfs(settings);</b>
<b class="fc"><i>108</i>&nbsp;      loadCustomLogImpl(settings);</b>
<b class="fc"><i>109</i>&nbsp;      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</b>
<b class="fc"><i>110</i>&nbsp;      pluginElement(root.evalNode(&quot;plugins&quot;));</b>
<b class="fc"><i>111</i>&nbsp;      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</b>
<b class="fc"><i>112</i>&nbsp;      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</b>
<b class="fc"><i>113</i>&nbsp;      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</b>
<b class="fc"><i>114</i>&nbsp;      settingsElement(settings);</b>
<i>115</i>&nbsp;      // read it after objectFactory and objectWrapperFactory issue #631
<b class="fc"><i>116</i>&nbsp;      environmentsElement(root.evalNode(&quot;environments&quot;));</b>
<b class="fc"><i>117</i>&nbsp;      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</b>
<b class="fc"><i>118</i>&nbsp;      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</b>
<b class="fc"><i>119</i>&nbsp;      mapperElement(root.evalNode(&quot;mappers&quot;));</b>
<b class="fc"><i>120</i>&nbsp;    } catch (Exception e) {</b>
<b class="fc"><i>121</i>&nbsp;      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</b>
<b class="fc"><i>122</i>&nbsp;    }</b>
<b class="fc"><i>123</i>&nbsp;  }</b>
<i>124</i>&nbsp;
<i>125</i>&nbsp;  private Properties settingsAsProperties(XNode context) {
<b class="fc"><i>126</i>&nbsp;    if (context == null) {</b>
<b class="fc"><i>127</i>&nbsp;      return new Properties();</b>
<i>128</i>&nbsp;    }
<b class="fc"><i>129</i>&nbsp;    Properties props = context.getChildrenAsProperties();</b>
<i>130</i>&nbsp;    // Check that all settings are known to the configuration class
<b class="fc"><i>131</i>&nbsp;    MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</b>
<b class="fc"><i>132</i>&nbsp;    for (Object key : props.keySet()) {</b>
<b class="fc"><i>133</i>&nbsp;      if (!metaConfig.hasSetter(String.valueOf(key))) {</b>
<b class="fc"><i>134</i>&nbsp;        throw new BuilderException(&quot;The setting &quot; + key + &quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;);</b>
<i>135</i>&nbsp;      }
<b class="fc"><i>136</i>&nbsp;    }</b>
<b class="fc"><i>137</i>&nbsp;    return props;</b>
<i>138</i>&nbsp;  }
<i>139</i>&nbsp;
<i>140</i>&nbsp;  private void loadCustomVfs(Properties props) throws ClassNotFoundException {
<b class="fc"><i>141</i>&nbsp;    String value = props.getProperty(&quot;vfsImpl&quot;);</b>
<b class="fc"><i>142</i>&nbsp;    if (value != null) {</b>
<b class="fc"><i>143</i>&nbsp;      String[] clazzes = value.split(&quot;,&quot;);</b>
<b class="fc"><i>144</i>&nbsp;      for (String clazz : clazzes) {</b>
<b class="fc"><i>145</i>&nbsp;        if (!clazz.isEmpty()) {</b>
<i>146</i>&nbsp;          @SuppressWarnings(&quot;unchecked&quot;)
<b class="fc"><i>147</i>&nbsp;          Class&lt;? extends VFS&gt; vfsImpl = (Class&lt;? extends VFS&gt;)Resources.classForName(clazz);</b>
<b class="fc"><i>148</i>&nbsp;          configuration.setVfsImpl(vfsImpl);</b>
<i>149</i>&nbsp;        }
<i>150</i>&nbsp;      }
<i>151</i>&nbsp;    }
<b class="fc"><i>152</i>&nbsp;  }</b>
<i>153</i>&nbsp;
<i>154</i>&nbsp;  private void loadCustomLogImpl(Properties props) {
<b class="fc"><i>155</i>&nbsp;    Class&lt;? extends Log&gt; logImpl = resolveClass(props.getProperty(&quot;logImpl&quot;));</b>
<b class="fc"><i>156</i>&nbsp;    configuration.setLogImpl(logImpl);</b>
<b class="fc"><i>157</i>&nbsp;  }</b>
<i>158</i>&nbsp;
<i>159</i>&nbsp;  private void typeAliasesElement(XNode parent) {
<b class="fc"><i>160</i>&nbsp;    if (parent != null) {</b>
<b class="fc"><i>161</i>&nbsp;      for (XNode child : parent.getChildren()) {</b>
<b class="fc"><i>162</i>&nbsp;        if (&quot;package&quot;.equals(child.getName())) {</b>
<b class="fc"><i>163</i>&nbsp;          String typeAliasPackage = child.getStringAttribute(&quot;name&quot;);</b>
<b class="fc"><i>164</i>&nbsp;          configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</b>
<b class="fc"><i>165</i>&nbsp;        } else {</b>
<b class="fc"><i>166</i>&nbsp;          String alias = child.getStringAttribute(&quot;alias&quot;);</b>
<b class="fc"><i>167</i>&nbsp;          String type = child.getStringAttribute(&quot;type&quot;);</b>
<i>168</i>&nbsp;          try {
<b class="fc"><i>169</i>&nbsp;            Class&lt;?&gt; clazz = Resources.classForName(type);</b>
<b class="fc"><i>170</i>&nbsp;            if (alias == null) {</b>
<b class="fc"><i>171</i>&nbsp;              typeAliasRegistry.registerAlias(clazz);</b>
<i>172</i>&nbsp;            } else {
<b class="fc"><i>173</i>&nbsp;              typeAliasRegistry.registerAlias(alias, clazz);</b>
<i>174</i>&nbsp;            }
<b class="fc"><i>175</i>&nbsp;          } catch (ClassNotFoundException e) {</b>
<b class="fc"><i>176</i>&nbsp;            throw new BuilderException(&quot;Error registering typeAlias for &#39;&quot; + alias + &quot;&#39;. Cause: &quot; + e, e);</b>
<b class="fc"><i>177</i>&nbsp;          }</b>
<i>178</i>&nbsp;        }
<b class="fc"><i>179</i>&nbsp;      }</b>
<i>180</i>&nbsp;    }
<b class="fc"><i>181</i>&nbsp;  }</b>
<i>182</i>&nbsp;
<i>183</i>&nbsp;  private void pluginElement(XNode parent) throws Exception {
<b class="fc"><i>184</i>&nbsp;    if (parent != null) {</b>
<b class="fc"><i>185</i>&nbsp;      for (XNode child : parent.getChildren()) {</b>
<b class="fc"><i>186</i>&nbsp;        String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</b>
<b class="fc"><i>187</i>&nbsp;        Properties properties = child.getChildrenAsProperties();</b>
<b class="fc"><i>188</i>&nbsp;        Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();</b>
<b class="fc"><i>189</i>&nbsp;        interceptorInstance.setProperties(properties);</b>
<b class="fc"><i>190</i>&nbsp;        configuration.addInterceptor(interceptorInstance);</b>
<b class="fc"><i>191</i>&nbsp;      }</b>
<i>192</i>&nbsp;    }
<b class="fc"><i>193</i>&nbsp;  }</b>
<i>194</i>&nbsp;
<i>195</i>&nbsp;  private void objectFactoryElement(XNode context) throws Exception {
<b class="fc"><i>196</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>197</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<b class="fc"><i>198</i>&nbsp;      Properties properties = context.getChildrenAsProperties();</b>
<b class="fc"><i>199</i>&nbsp;      ObjectFactory factory = (ObjectFactory) resolveClass(type).newInstance();</b>
<b class="fc"><i>200</i>&nbsp;      factory.setProperties(properties);</b>
<b class="fc"><i>201</i>&nbsp;      configuration.setObjectFactory(factory);</b>
<i>202</i>&nbsp;    }
<b class="fc"><i>203</i>&nbsp;  }</b>
<i>204</i>&nbsp;
<i>205</i>&nbsp;  private void objectWrapperFactoryElement(XNode context) throws Exception {
<b class="fc"><i>206</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>207</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<b class="fc"><i>208</i>&nbsp;      ObjectWrapperFactory factory = (ObjectWrapperFactory) resolveClass(type).newInstance();</b>
<b class="fc"><i>209</i>&nbsp;      configuration.setObjectWrapperFactory(factory);</b>
<i>210</i>&nbsp;    }
<b class="fc"><i>211</i>&nbsp;  }</b>
<i>212</i>&nbsp;
<i>213</i>&nbsp;  private void reflectorFactoryElement(XNode context) throws Exception {
<b class="fc"><i>214</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>215</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<b class="fc"><i>216</i>&nbsp;      ReflectorFactory factory = (ReflectorFactory) resolveClass(type).newInstance();</b>
<b class="fc"><i>217</i>&nbsp;      configuration.setReflectorFactory(factory);</b>
<i>218</i>&nbsp;    }
<b class="fc"><i>219</i>&nbsp;  }</b>
<i>220</i>&nbsp;
<i>221</i>&nbsp;  private void propertiesElement(XNode context) throws Exception {
<b class="fc"><i>222</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>223</i>&nbsp;      Properties defaults = context.getChildrenAsProperties();</b>
<b class="fc"><i>224</i>&nbsp;      String resource = context.getStringAttribute(&quot;resource&quot;);</b>
<b class="fc"><i>225</i>&nbsp;      String url = context.getStringAttribute(&quot;url&quot;);</b>
<b class="fc"><i>226</i>&nbsp;      if (resource != null &amp;&amp; url != null) {</b>
<b class="fc"><i>227</i>&nbsp;        throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</b>
<i>228</i>&nbsp;      }
<b class="fc"><i>229</i>&nbsp;      if (resource != null) {</b>
<b class="fc"><i>230</i>&nbsp;        defaults.putAll(Resources.getResourceAsProperties(resource));</b>
<b class="fc"><i>231</i>&nbsp;      } else if (url != null) {</b>
<b class="fc"><i>232</i>&nbsp;        defaults.putAll(Resources.getUrlAsProperties(url));</b>
<i>233</i>&nbsp;      }
<b class="fc"><i>234</i>&nbsp;      Properties vars = configuration.getVariables();</b>
<b class="fc"><i>235</i>&nbsp;      if (vars != null) {</b>
<b class="fc"><i>236</i>&nbsp;        defaults.putAll(vars);</b>
<i>237</i>&nbsp;      }
<b class="fc"><i>238</i>&nbsp;      parser.setVariables(defaults);</b>
<b class="fc"><i>239</i>&nbsp;      configuration.setVariables(defaults);</b>
<i>240</i>&nbsp;    }
<b class="fc"><i>241</i>&nbsp;  }</b>
<i>242</i>&nbsp;
<i>243</i>&nbsp;  private void settingsElement(Properties props) {
<b class="fc"><i>244</i>&nbsp;    configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty(&quot;autoMappingBehavior&quot;, &quot;PARTIAL&quot;)));</b>
<b class="fc"><i>245</i>&nbsp;    configuration.setAutoMappingUnknownColumnBehavior(AutoMappingUnknownColumnBehavior.valueOf(props.getProperty(&quot;autoMappingUnknownColumnBehavior&quot;, &quot;NONE&quot;)));</b>
<b class="fc"><i>246</i>&nbsp;    configuration.setCacheEnabled(booleanValueOf(props.getProperty(&quot;cacheEnabled&quot;), true));</b>
<b class="fc"><i>247</i>&nbsp;    configuration.setProxyFactory((ProxyFactory) createInstance(props.getProperty(&quot;proxyFactory&quot;)));</b>
<b class="fc"><i>248</i>&nbsp;    configuration.setLazyLoadingEnabled(booleanValueOf(props.getProperty(&quot;lazyLoadingEnabled&quot;), false));</b>
<b class="fc"><i>249</i>&nbsp;    configuration.setAggressiveLazyLoading(booleanValueOf(props.getProperty(&quot;aggressiveLazyLoading&quot;), false));</b>
<b class="fc"><i>250</i>&nbsp;    configuration.setMultipleResultSetsEnabled(booleanValueOf(props.getProperty(&quot;multipleResultSetsEnabled&quot;), true));</b>
<b class="fc"><i>251</i>&nbsp;    configuration.setUseColumnLabel(booleanValueOf(props.getProperty(&quot;useColumnLabel&quot;), true));</b>
<b class="fc"><i>252</i>&nbsp;    configuration.setUseGeneratedKeys(booleanValueOf(props.getProperty(&quot;useGeneratedKeys&quot;), false));</b>
<b class="fc"><i>253</i>&nbsp;    configuration.setDefaultExecutorType(ExecutorType.valueOf(props.getProperty(&quot;defaultExecutorType&quot;, &quot;SIMPLE&quot;)));</b>
<b class="fc"><i>254</i>&nbsp;    configuration.setDefaultStatementTimeout(integerValueOf(props.getProperty(&quot;defaultStatementTimeout&quot;), null));</b>
<b class="fc"><i>255</i>&nbsp;    configuration.setDefaultFetchSize(integerValueOf(props.getProperty(&quot;defaultFetchSize&quot;), null));</b>
<b class="fc"><i>256</i>&nbsp;    configuration.setMapUnderscoreToCamelCase(booleanValueOf(props.getProperty(&quot;mapUnderscoreToCamelCase&quot;), false));</b>
<b class="fc"><i>257</i>&nbsp;    configuration.setSafeRowBoundsEnabled(booleanValueOf(props.getProperty(&quot;safeRowBoundsEnabled&quot;), false));</b>
<b class="fc"><i>258</i>&nbsp;    configuration.setLocalCacheScope(LocalCacheScope.valueOf(props.getProperty(&quot;localCacheScope&quot;, &quot;SESSION&quot;)));</b>
<b class="fc"><i>259</i>&nbsp;    configuration.setJdbcTypeForNull(JdbcType.valueOf(props.getProperty(&quot;jdbcTypeForNull&quot;, &quot;OTHER&quot;)));</b>
<b class="fc"><i>260</i>&nbsp;    configuration.setLazyLoadTriggerMethods(stringSetValueOf(props.getProperty(&quot;lazyLoadTriggerMethods&quot;), &quot;equals,clone,hashCode,toString&quot;));</b>
<b class="fc"><i>261</i>&nbsp;    configuration.setSafeResultHandlerEnabled(booleanValueOf(props.getProperty(&quot;safeResultHandlerEnabled&quot;), true));</b>
<b class="fc"><i>262</i>&nbsp;    configuration.setDefaultScriptingLanguage(resolveClass(props.getProperty(&quot;defaultScriptingLanguage&quot;)));</b>
<b class="fc"><i>263</i>&nbsp;    configuration.setDefaultEnumTypeHandler(resolveClass(props.getProperty(&quot;defaultEnumTypeHandler&quot;)));</b>
<b class="fc"><i>264</i>&nbsp;    configuration.setCallSettersOnNulls(booleanValueOf(props.getProperty(&quot;callSettersOnNulls&quot;), false));</b>
<b class="fc"><i>265</i>&nbsp;    configuration.setUseActualParamName(booleanValueOf(props.getProperty(&quot;useActualParamName&quot;), true));</b>
<b class="fc"><i>266</i>&nbsp;    configuration.setReturnInstanceForEmptyRow(booleanValueOf(props.getProperty(&quot;returnInstanceForEmptyRow&quot;), false));</b>
<b class="fc"><i>267</i>&nbsp;    configuration.setLogPrefix(props.getProperty(&quot;logPrefix&quot;));</b>
<b class="fc"><i>268</i>&nbsp;    configuration.setConfigurationFactory(resolveClass(props.getProperty(&quot;configurationFactory&quot;)));</b>
<b class="fc"><i>269</i>&nbsp;  }</b>
<i>270</i>&nbsp;
<i>271</i>&nbsp;  private void environmentsElement(XNode context) throws Exception {
<b class="fc"><i>272</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>273</i>&nbsp;      if (environment == null) {</b>
<b class="fc"><i>274</i>&nbsp;        environment = context.getStringAttribute(&quot;default&quot;);</b>
<i>275</i>&nbsp;      }
<b class="fc"><i>276</i>&nbsp;      for (XNode child : context.getChildren()) {</b>
<b class="fc"><i>277</i>&nbsp;        String id = child.getStringAttribute(&quot;id&quot;);</b>
<b class="fc"><i>278</i>&nbsp;        if (isSpecifiedEnvironment(id)) {</b>
<b class="fc"><i>279</i>&nbsp;          TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</b>
<b class="fc"><i>280</i>&nbsp;          DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;));</b>
<b class="fc"><i>281</i>&nbsp;          DataSource dataSource = dsFactory.getDataSource();</b>
<b class="fc"><i>282</i>&nbsp;          Environment.Builder environmentBuilder = new Environment.Builder(id)</b>
<b class="fc"><i>283</i>&nbsp;              .transactionFactory(txFactory)</b>
<b class="fc"><i>284</i>&nbsp;              .dataSource(dataSource);</b>
<b class="fc"><i>285</i>&nbsp;          configuration.setEnvironment(environmentBuilder.build());</b>
<i>286</i>&nbsp;        }
<b class="fc"><i>287</i>&nbsp;      }</b>
<i>288</i>&nbsp;    }
<b class="fc"><i>289</i>&nbsp;  }</b>
<i>290</i>&nbsp;
<i>291</i>&nbsp;  private void databaseIdProviderElement(XNode context) throws Exception {
<b class="fc"><i>292</i>&nbsp;    DatabaseIdProvider databaseIdProvider = null;</b>
<b class="fc"><i>293</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>294</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<i>295</i>&nbsp;      // awful patch to keep backward compatibility
<b class="fc"><i>296</i>&nbsp;      if (&quot;VENDOR&quot;.equals(type)) {</b>
<b class="nc"><i>297</i>&nbsp;        type = &quot;DB_VENDOR&quot;;</b>
<i>298</i>&nbsp;      }
<b class="fc"><i>299</i>&nbsp;      Properties properties = context.getChildrenAsProperties();</b>
<b class="fc"><i>300</i>&nbsp;      databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance();</b>
<b class="fc"><i>301</i>&nbsp;      databaseIdProvider.setProperties(properties);</b>
<i>302</i>&nbsp;    }
<b class="fc"><i>303</i>&nbsp;    Environment environment = configuration.getEnvironment();</b>
<b class="fc"><i>304</i>&nbsp;    if (environment != null &amp;&amp; databaseIdProvider != null) {</b>
<b class="fc"><i>305</i>&nbsp;      String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource());</b>
<b class="fc"><i>306</i>&nbsp;      configuration.setDatabaseId(databaseId);</b>
<i>307</i>&nbsp;    }
<b class="fc"><i>308</i>&nbsp;  }</b>
<i>309</i>&nbsp;
<i>310</i>&nbsp;  private TransactionFactory transactionManagerElement(XNode context) throws Exception {
<b class="fc"><i>311</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>312</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<b class="fc"><i>313</i>&nbsp;      Properties props = context.getChildrenAsProperties();</b>
<b class="fc"><i>314</i>&nbsp;      TransactionFactory factory = (TransactionFactory) resolveClass(type).newInstance();</b>
<b class="fc"><i>315</i>&nbsp;      factory.setProperties(props);</b>
<b class="fc"><i>316</i>&nbsp;      return factory;</b>
<i>317</i>&nbsp;    }
<b class="nc"><i>318</i>&nbsp;    throw new BuilderException(&quot;Environment declaration requires a TransactionFactory.&quot;);</b>
<i>319</i>&nbsp;  }
<i>320</i>&nbsp;
<i>321</i>&nbsp;  private DataSourceFactory dataSourceElement(XNode context) throws Exception {
<b class="fc"><i>322</i>&nbsp;    if (context != null) {</b>
<b class="fc"><i>323</i>&nbsp;      String type = context.getStringAttribute(&quot;type&quot;);</b>
<b class="fc"><i>324</i>&nbsp;      Properties props = context.getChildrenAsProperties();</b>
<b class="fc"><i>325</i>&nbsp;      DataSourceFactory factory = (DataSourceFactory) resolveClass(type).newInstance();</b>
<b class="fc"><i>326</i>&nbsp;      factory.setProperties(props);</b>
<b class="fc"><i>327</i>&nbsp;      return factory;</b>
<i>328</i>&nbsp;    }
<b class="nc"><i>329</i>&nbsp;    throw new BuilderException(&quot;Environment declaration requires a DataSourceFactory.&quot;);</b>
<i>330</i>&nbsp;  }
<i>331</i>&nbsp;
<i>332</i>&nbsp;  private void typeHandlerElement(XNode parent) {
<b class="fc"><i>333</i>&nbsp;    if (parent != null) {</b>
<b class="fc"><i>334</i>&nbsp;      for (XNode child : parent.getChildren()) {</b>
<b class="fc"><i>335</i>&nbsp;        if (&quot;package&quot;.equals(child.getName())) {</b>
<b class="fc"><i>336</i>&nbsp;          String typeHandlerPackage = child.getStringAttribute(&quot;name&quot;);</b>
<b class="fc"><i>337</i>&nbsp;          typeHandlerRegistry.register(typeHandlerPackage);</b>
<b class="fc"><i>338</i>&nbsp;        } else {</b>
<b class="fc"><i>339</i>&nbsp;          String javaTypeName = child.getStringAttribute(&quot;javaType&quot;);</b>
<b class="fc"><i>340</i>&nbsp;          String jdbcTypeName = child.getStringAttribute(&quot;jdbcType&quot;);</b>
<b class="fc"><i>341</i>&nbsp;          String handlerTypeName = child.getStringAttribute(&quot;handler&quot;);</b>
<b class="fc"><i>342</i>&nbsp;          Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);</b>
<b class="fc"><i>343</i>&nbsp;          JdbcType jdbcType = resolveJdbcType(jdbcTypeName);</b>
<b class="fc"><i>344</i>&nbsp;          Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);</b>
<b class="fc"><i>345</i>&nbsp;          if (javaTypeClass != null) {</b>
<b class="fc"><i>346</i>&nbsp;            if (jdbcType == null) {</b>
<b class="fc"><i>347</i>&nbsp;              typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</b>
<i>348</i>&nbsp;            } else {
<b class="fc"><i>349</i>&nbsp;              typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</b>
<i>350</i>&nbsp;            }
<i>351</i>&nbsp;          } else {
<b class="fc"><i>352</i>&nbsp;            typeHandlerRegistry.register(typeHandlerClass);</b>
<i>353</i>&nbsp;          }
<i>354</i>&nbsp;        }
<b class="fc"><i>355</i>&nbsp;      }</b>
<i>356</i>&nbsp;    }
<b class="fc"><i>357</i>&nbsp;  }</b>
<i>358</i>&nbsp;
<i>359</i>&nbsp;  private void mapperElement(XNode parent) throws Exception {
<b class="fc"><i>360</i>&nbsp;    if (parent != null) {</b>
<b class="fc"><i>361</i>&nbsp;      for (XNode child : parent.getChildren()) {</b>
<b class="fc"><i>362</i>&nbsp;        if (&quot;package&quot;.equals(child.getName())) {</b>
<b class="fc"><i>363</i>&nbsp;          String mapperPackage = child.getStringAttribute(&quot;name&quot;);</b>
<b class="fc"><i>364</i>&nbsp;          configuration.addMappers(mapperPackage);</b>
<b class="fc"><i>365</i>&nbsp;        } else {</b>
<b class="fc"><i>366</i>&nbsp;          String resource = child.getStringAttribute(&quot;resource&quot;);</b>
<b class="fc"><i>367</i>&nbsp;          String url = child.getStringAttribute(&quot;url&quot;);</b>
<b class="fc"><i>368</i>&nbsp;          String mapperClass = child.getStringAttribute(&quot;class&quot;);</b>
<b class="fc"><i>369</i>&nbsp;          if (resource != null &amp;&amp; url == null &amp;&amp; mapperClass == null) {</b>
<b class="fc"><i>370</i>&nbsp;            ErrorContext.instance().resource(resource);</b>
<b class="fc"><i>371</i>&nbsp;            InputStream inputStream = Resources.getResourceAsStream(resource);</b>
<b class="fc"><i>372</i>&nbsp;            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</b>
<b class="fc"><i>373</i>&nbsp;            mapperParser.parse();</b>
<b class="fc"><i>374</i>&nbsp;          } else if (resource == null &amp;&amp; url != null &amp;&amp; mapperClass == null) {</b>
<b class="fc"><i>375</i>&nbsp;            ErrorContext.instance().resource(url);</b>
<b class="fc"><i>376</i>&nbsp;            InputStream inputStream = Resources.getUrlAsStream(url);</b>
<b class="fc"><i>377</i>&nbsp;            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());</b>
<b class="fc"><i>378</i>&nbsp;            mapperParser.parse();</b>
<b class="fc"><i>379</i>&nbsp;          } else if (resource == null &amp;&amp; url == null &amp;&amp; mapperClass != null) {</b>
<b class="fc"><i>380</i>&nbsp;            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</b>
<b class="fc"><i>381</i>&nbsp;            configuration.addMapper(mapperInterface);</b>
<b class="fc"><i>382</i>&nbsp;          } else {</b>
<b class="nc"><i>383</i>&nbsp;            throw new BuilderException(&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;);</b>
<i>384</i>&nbsp;          }
<i>385</i>&nbsp;        }
<b class="fc"><i>386</i>&nbsp;      }</b>
<i>387</i>&nbsp;    }
<b class="fc"><i>388</i>&nbsp;  }</b>
<i>389</i>&nbsp;
<i>390</i>&nbsp;  private boolean isSpecifiedEnvironment(String id) {
<b class="fc"><i>391</i>&nbsp;    if (environment == null) {</b>
<b class="nc"><i>392</i>&nbsp;      throw new BuilderException(&quot;No environment specified.&quot;);</b>
<b class="fc"><i>393</i>&nbsp;    } else if (id == null) {</b>
<b class="nc"><i>394</i>&nbsp;      throw new BuilderException(&quot;Environment requires an id attribute.&quot;);</b>
<b class="fc"><i>395</i>&nbsp;    } else if (environment.equals(id)) {</b>
<b class="fc"><i>396</i>&nbsp;      return true;</b>
<i>397</i>&nbsp;    }
<b class="nc"><i>398</i>&nbsp;    return false;</b>
<i>399</i>&nbsp;  }
<i>400</i>&nbsp;
<i>401</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2019-03-04 09:14</div>
</div>
</body>
</html>
